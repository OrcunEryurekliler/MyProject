@model AppointmentBookingViewModel

<form asp-action="Book" method="post">
	<!-- uzmanlık & tarih -->
	<select asp-for="SelectedSpecializationId" asp-items="Model.Specializations"></select>
	<input asp-for="SelectedDate" type="date" />

	<button type="submit">Doktorları Getir</button>
</form>

@if (Model.AvailableDoctors?.Any() == true)
{
	<select asp-for="SelectedDoctorId" id="doctorSelect">
		@foreach (var d in Model.AvailableDoctors)
		{
			<option value="@d.Id">@d.FullName</option>
		}
	</select>
	<button id="loadSlots">Saatleri Göster</button>
	<select asp-for="SelectedAppointmentSlotId" name="SelectedAppointmentSlotId">
		<option>Seçiniz</option>
	</select>
}


@section Scripts {
	<script>
				document.getElementById('loadSlots').addEventListener('click', async () => {
		  const docSelect = document.getElementById('doctorSelect');
		  const docId = docSelect ? docSelect.value : null;
		  const dateInput = document.querySelector('input[name="SelectedDate"]');
		  const date = dateInput ? dateInput.value : null;
		  const slotSelect = document.querySelector('select[name="SelectedAppointmentSlotId"]');

		  if (!docId || !date) {
			alert('Lütfen doktor ve tarih seçiniz.');
			return;
		  }

		  slotSelect.innerHTML = '<option>Seçiniz</option>';

		  try {
			const response = await fetch(`/Appointment/Slots?doctorId=${docId}&date=${date}`);
			if (!response.ok) throw new Error('Sunucudan geçerli bir yanıt alınamadı.');
			const slots = await response.json();
					console.log("Gelen slotlar:", slots);
		slots.forEach(s => {
			console.log("Slot içeriği:", s);
		});

					slots.forEach(s => {
			var timeText = (s.slotTime || '').toString(); // null veya undefined olursa boş string olur

			var opt = document.createElement('option');
			opt.value = s.id;

			// Güvenli bir şekilde ilk 5 karakter (HH:mm) al
			opt.text = timeText.length >= 5 ? timeText.substring(0, 5) : timeText;

			if (!s.isAvailable) {
				opt.disabled = true;
				opt.style.color = 'red';
			}

			slotSelect.appendChild(opt);
		});

		  } catch (error) {
			console.error('Slotları yüklerken hata oluştu:', error);
			alert('Slotları yüklerken bir hata oluştu. Lütfen daha sonra tekrar deneyiniz.');
		  }
		});

	</script>
}
